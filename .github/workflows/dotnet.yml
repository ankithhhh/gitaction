name: .NET Automation Tests

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0

    - name: Restore dependencies
      run: dotnet restore

    - name: Build project
      run: dotnet build --no-restore

    - name: Run tests with SpecFlow
      run: |
        mkdir -p TestResults/ExtentReports TestResults/Screenshots
        dotnet test RashmiProject.sln --logger "trx;LogFileName=TestResults/test_results.trx"

    - name: Check for Extent Report
      id: check_report
      run: |
        REPORT_FILE=$(find TestResults/ExtentReports -name "ExtentReport.html" | head -n 1)
        if [ -f "$REPORT_FILE" ]; then
          echo "REPORT_FOUND=true" >> $GITHUB_ENV
        else
          echo "REPORT_FOUND=false" >> $GITHUB_ENV
        fi

    - name: Send email if test fails
      if: failure() && env.REPORT_FOUND == 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.GMAIL_USERNAME }}
        password: ${{ secrets.GMAIL_PASSWORD }}
        subject: "Test Failed - Screenshot and Extent Report Attached"
        body: |
          Hello Ankith,

          One or more tests have failed. Please find the attached Extent Report and screenshots.

          Regards,
          GitHub Actions
        to: "ankiamin77@gmail.com"
        from: ${{ secrets.GMAIL_USERNAME }}
        attachments: |
          TestResults/Screenshots/*
          TestResults/ExtentReports/*
